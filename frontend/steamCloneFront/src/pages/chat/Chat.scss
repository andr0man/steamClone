@use "../../styles/variables" as variables;

$bg: #141320;
$text-2: #c8d0d8;
$text-3: #9aa6b3;
$muted: #6a6391;
$accent: #A178EB;
$accent2: #3DFFB3;

:root { --navbar-h: 64px; }

@mixin border-gradient($radius: 10px, $pad: 2px, $opacity: .85) {
  position: relative;
  &::after {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: $radius;
    padding: $pad;
    background: variables.rainbow(270deg);
    background-size: 200% 200%;
    -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
    -webkit-mask-composite: xor;
    mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
    mask-composite: exclude;
    pointer-events: none;
    opacity: $opacity;
    animation: btnGradient 6s ease infinite;
  }
}

@keyframes btnGradient { 0% { background-position: 0% 50% } 50% { background-position: 100% 50% } 100% { background-position: 0% 50% } }
@keyframes chatBounce { 0%,80%,100% { transform: translateY(0); opacity:.6 } 40% { transform: translateY(-4px); opacity:1 } }

.flux-chat-page {
  min-height: 100svh;
  padding-top: calc(var(--navbar-h) + 16px);
  font-family: variables.$font-primary;
  color: variables.$ink;
  position: relative;
  isolation: isolate;

  &::before {
    content: '';
    position: fixed;
    inset: 0;
    background-color: $bg;
    background-image: url('/authbc/BG_grey.svg');
    background-repeat: no-repeat;
    background-position: center top;
    background-size: cover;
    pointer-events: none;
    z-index: -1;
  }

  .page-inset {
    width: min(1760px, calc(100% - clamp(16px, 3vw, 32px) * 2));
    margin-inline: auto;
    padding-inline: clamp(16px, 3vw, 32px);
  }

  .chat-tabs {
    display: inline-flex;
    gap: 8px;
    margin: 8px 0 6px;

    .tab {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 8px 14px;
      min-height: 36px;
      border: 0;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 800;
      color: variables.$ink;
      background: linear-gradient(180deg, rgba(#2b2b34,.6), rgba(#1a1a22,.82));
      transition: transform .15s ease, filter .2s ease, box-shadow .2s ease, background .25s ease, color .2s ease;
      @include border-gradient(999px, 2px, .85);

      &:hover { transform: translateY(-1px); filter: brightness(1.06); }
      &:active { transform: translateY(0); }

      &.active {
        background: linear-gradient(90deg, rgba(#a178eb,.35) 0%, rgba(#66c0f4,.35) 100%), linear-gradient(180deg, rgba(#2b2b34,.7), rgba(#1a1a22,.9));
        box-shadow: 0 6px 16px rgba(124,114,219,.22);
      }
    }
  }

  .chat-grid {
    display: grid;
    grid-template-columns: 360px 1fr;
    gap: 22px;
    margin: 8px 0 40px;
    height: calc(100svh - var(--navbar-h) - 80px);
    &.single { grid-template-columns: 1fr; }
  }

  .panel {
    background: variables.$panel-bg;
    border: 1px solid variables.$panel-border;
    border-radius: 8px;
    box-shadow: variables.$panel-shadow;
    padding: 18px;
    height: 100%;
    min-height: 0;
  }

  .chat-side {
    display: grid;
    grid-template-rows: auto auto auto 1fr auto;
    gap: 14px;
    min-height: 0;
    overflow: hidden;
  }
  .side-title { font: 800 22px/1 variables.$font-primary; color: #fff; }
  .side-underline { display: block; width: 180px; height: 1px; background: rgba(255,255,255,.9); margin: 6px 0 4px; }

  .side-search { position: relative; }
  .side-search input {
    width: 100%; background: transparent; border: 0; border-bottom: 1px solid rgba(255,255,255,.25); outline: none; color: variables.$ink; padding: 10px 32px 10px 0;
    &::placeholder { color: #565558; }
  }
  .side-search button {
    position: absolute; right: 0; top: 50%; transform: translateY(-50%);
    width: 32px; height: 32px; padding: 0; border: 0; background: transparent; cursor: pointer;
    border-radius: 8px;
    @include border-gradient(8px, 1.5px, .6);
  }
  .side-search img { width: 18px; height: 18px; }

  .side-cats { display: flex; flex-wrap: wrap; gap: 8px; }
  .cat-pill {
    background: rgba(146,119,197,.18); border: 1px solid rgba(146,119,197,.45); color: variables.$ink; padding: 8px 12px; border-radius: 20px; cursor: pointer; transition: .2s ease; font-weight: 700;
  }
  .cat-pill:hover { filter: brightness(1.08); transform: translateY(-1px); }
  .cat-pill.active { background: #292035; border-color: variables.$panel-border; }

  .side-section { display: grid; gap: 10px; min-height: 0; }
  .side-subtitle { font-weight: 800; color: #fff; }
  .qa-list {
    display: grid;
    gap: 8px;
    height: 100%;
    overflow: auto;
    padding-right: 4px;
  }
  .qa-list::-webkit-scrollbar { width: 6px; }
  .qa-list::-webkit-scrollbar-thumb { background: rgba(146,119,197,.35); border-radius: 4px; }
  .qa-row {
    display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; width: 100%;
    background: rgba(114,90,158,.08); border: 1px solid transparent; padding: 10px 12px; cursor: pointer; border-radius: 8px; transition: .2s ease; text-align: left;
  }
  .qa-row:hover { border-color: rgba(146,119,197,.4); background: rgba(114,90,158,.14); }
  .qa-title { color: variables.$ink; font-weight: 700; }
  .qa-cat { color: $text-3; font-size: 12px; padding: 2px 8px; border: 1px dashed rgba(146,119,197,.45); border-radius: 12px; }
  .side-empty { color: $text-3; font-size: 14px; }

  .side-actions { margin-top: 6px; }
  .ticket-btn {
    width: 100%; height: 44px; font-weight: 900; border: 0; border-radius: 10px; cursor: pointer; transition: .2s ease; color: #121218;
    background: linear-gradient(180deg, #cdb8ff 0%, #a88fe0 100%);
    border: 1px solid rgba(255,255,255,.25);
    @include border-gradient(10px, 2px, .8);
  }
  .ticket-btn:hover { transform: translateY(-1px); filter: brightness(1.05); }

  .chat-main {
    display: grid;
    grid-template-rows: auto auto 1fr auto;
    gap: 10px;
    min-height: 0;
    overflow: hidden;
  }

  .chat-header {
    display: flex; align-items: center; justify-content: space-between;
    padding-bottom: 10px; border-bottom: 1px dashed rgba(146,119,197,.35);
  }
  .assistant-badge { width: 14px; height: 14px; border-radius: 50%; background: #1f1a2a; border: 1px solid rgba(146,119,197,.4); display: grid; place-items: center; margin-right: 8px; }
  .assistant-badge .dot { width: 6px; height: 6px; border-radius: 50%; background: $accent2; box-shadow: 0 0 10px rgba(61,255,179,.6); }
  .who { display: inline-grid; gap: 2px; }
  .who .name { font-weight: 900; color: #fff; }
  .who .status { color: $text-3; font-size: 12px; }
  .mini-indicator { color: $text-3; font-size: 12px; }

  .chat-thread {
    display: flex;
    flex-direction: column;
    gap: 10px;
    overflow: auto;
    padding-right: 6px;
    min-height: 0;
    height: 100%;
  }
  .chat-thread::-webkit-scrollbar { width: 8px; }
  .chat-thread::-webkit-scrollbar-thumb { background: rgba(146,119,197,.35); border-radius: 4px; }

  .msg { display: flex; }
  .msg.me { justify-content: flex-end; }
  .msg .bubble {
    max-width: 72ch; padding: 12px 14px; border-radius: 12px; border: 1px solid rgba(146,119,197,.45); background: #181320; position: relative;
  }
  .msg.me .bubble { background: linear-gradient(180deg, rgba(61,255,179,.14), rgba(114,90,158,.12)); border: 1px solid rgba(61,255,179,.45); border-radius: 12px 12px 4px 12px; }
  .msg.bot .bubble { border-radius: 12px 12px 12px 4px; background: radial-gradient(120% 120% at 0% 0%, rgba(162,120,235,.18) 0%, rgba(18,17,23,1) 60%); }
  .msg.bot.bot-welcome .bubble { background: radial-gradient(120% 120% at 0% 0%, rgba(162,120,235,.24) 0%, rgba(18,17,23,1) 60%); }

  .title { font-weight: 900; color: #fff; margin-bottom: 6px; }
  .text { color: $text-2; }
  .meta { margin-top: 6px; text-align: right; }
  .time { color: $muted; font-size: 12px; }

  .steps { margin: 6px 0 8px 18px; color: $text-2; }
  .steps li { margin: 4px 0; }

  .links { display: flex; gap: 8px; flex-wrap: wrap; margin: 4px 0 2px; }
  .link { color: #fff; text-decoration: none; border: 1px solid rgba(255,255,255,.25); border-radius: 6px; padding: 6px 10px; background: #292035; transition: .2s ease; }
  .link:hover { filter: brightness(1.08); transform: translateY(-1px); }

  .actions-row { display: inline-flex; align-items: center; gap: 8px; margin-top: 6px; color: $text-3; font-size: 12px; }
  .rate {
    display: inline-flex; align-items: center; justify-content: center;
    min-height: 28px; padding: 4px 10px; border-radius: 10px; cursor: pointer; font-weight: 800; font-size: 12px; color: variables.$ink; transition: .2s ease;
    background: linear-gradient(180deg, rgba(#2b2b34,.5), rgba(#1a1a22,.8));
    border: 0;
    @include border-gradient(10px, 1.5px, .7);
  }
  .rate:hover { filter: brightness(1.1); transform: translateY(-1px); }
  .rate.active { background: linear-gradient(90deg, rgba(#a178eb,.25), rgba(#66c0f4,.25)), linear-gradient(180deg, rgba(#2b2b34,.6), rgba(#1a1a22,.9)); }

  .sugg-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
  .sugg-chip {
    display: inline-flex; align-items: center; justify-content: center;
    width: 148px; height: 56px; padding: 0 10px; font-size: 12px; font-weight: 800; border-radius: 12px; cursor: pointer; text-align: center; line-height: 1.1;
    color: variables.$ink; border: 0; transition: .2s ease; white-space: normal; word-break: break-word; overflow: hidden;
    background: linear-gradient(180deg, rgba(116, 102, 168, 0.18) 0%, rgba(41, 32, 53, 0.36) 100%);
    @include border-gradient(12px, 2px, .75);
  }
  .sugg-chip:hover { filter: brightness(1.08); transform: translateY(-1px); }
  .sugg-chip.alt {
    color: #121218;
    background: linear-gradient(180deg, #cdb8ff 0%, #a88fe0 100%);
  }

  .composer { display: grid; gap: 10px; padding-top: 8px; border-top: 1px dashed rgba(146,119,197,.35); }
  .chips { display: flex; flex-wrap: wrap; gap: 6px; }
  .chip {
    display: inline-flex; align-items: center; justify-content: center;
    width: 132px; height: 40px; padding: 0 8px; font-size: 12px; font-weight: 800; border-radius: 12px; cursor: pointer; text-align: center; line-height: 1.1;
    color: variables.$ink; border: 0; transition: .2s ease; white-space: normal; word-break: break-word; overflow: hidden;
    background: linear-gradient(180deg, rgba(#2b2b34,.5), rgba(#1a1a22,.8));
    @include border-gradient(12px, 2px, .7);
  }
  .chip:hover { filter: brightness(1.08); transform: translateY(-1px); }

  .composer-row { display: grid; grid-template-columns: 1fr auto; gap: 10px; }
  .composer-row textarea {
    width: 100%; resize: none; min-height: 48px; max-height: 160px; padding: 12px; background: #181320; border: 1px solid rgba(146,119,197,.45);
    color: variables.$ink; outline: none; border-radius: 8px; font-size: 14px; line-height: 1.4;
  }
  .composer-row textarea::placeholder { color: #565558; }
  .send-btn {
    width: 52px; height: 44px; display: grid; place-items: center; cursor: pointer; transition: .2s ease; border: 0; border-radius: 10px; color: #121218;
    background: linear-gradient(180deg, #cdb8ff 0%, #a88fe0 100%);
    @include border-gradient(10px, 2px, .8);
  }
  .send-btn:disabled { opacity: .6; cursor: not-allowed; }
  .send-btn:hover:not(:disabled) { transform: translateY(-1px); filter: brightness(1.05); }

  .ai-mode { grid-template-rows: auto auto 1fr auto; }
  .ai-controls { display: inline-flex; gap: 8px; align-items: center; }
  .ai-controls .sm { color: $text-3; font-size: 12px; margin-right: 6px; }
  .ai-controls select {
    height: 32px; padding: 0 8px; border-radius: 8px; background: #161424; color: #fff; border: 1px solid rgba(255,255,255,.18); outline: none;
  }
  .ai-controls .ghost {
    height: 32px; padding: 0 10px; font-size: 12px; font-weight: 800; border-radius: 10px; color: variables.$ink; background: transparent; border: 0; cursor: pointer;
    @include border-gradient(10px, 1.5px, .7);
    transition: .2s ease;
  }
  .ai-controls .ghost:hover { transform: translateY(-1px); filter: brightness(1.06); }

  .sys-row { display: grid; grid-template-columns: 80px 1fr; gap: 10px; }
  .sys-row label { align-self: center; color: $text-3; font-size: 13px; }
  .sys-row input {
    height: 40px; border-radius: 8px; border: 1px solid rgba(255,255,255,.18); background: #161424; color: #fff; padding: 0 10px; outline: none;
  }

  .ai-error {
    border: 1px solid rgba(255,99,99,.45);
    background: rgba(255,99,99,.1);
    color: #ffcccc;
    border-radius: 8px;
    padding: 8px 10px;
    font-size: 14px;
  }

  .ai-thread { min-height: 0; }

  .ai-composer { display: grid; grid-template-columns: 1fr auto; gap: 10px; }
  .ai-composer textarea {
    width: 100%; resize: none; min-height: 48px; max-height: 160px; padding: 12px; background: #181320; border: 1px solid rgba(146,119,197,.45);
    color: #fff; outline: none; border-radius: 8px; font-size: 14px; line-height: 1.35;
  }
  .ai-composer .send-btn {
    width: 120px; height: 44px; border-radius: 10px; border: 0; color: #121218; font-weight: 900; cursor: pointer; transition: .2s ease;
    background: linear-gradient(180deg, #cdb8ff 0%, #a88fe0 100%);
    @include border-gradient(10px, 2px, .8);
  }

  .ticket-overlay { position: fixed; inset: 0; background: rgba(18, 17, 23, .7); backdrop-filter: blur(6px); display: grid; place-items: center; z-index: 80; }
  .ticket-modal { width: min(520px, calc(100% - 32px)); background: variables.$panel-bg; border: 1px solid variables.$panel-border; border-radius: 8px; box-shadow: variables.$panel-shadow; padding: 18px 18px 20px; position: relative; }
  .ticket-modal .close { position: absolute; right: 12px; top: 10px; background: transparent; border: 0; color: #cdb8ff; font-size: 22px; cursor: pointer; }
  .ticket-modal h3 { margin: 0 0 10px; color: #fff; }
  .field { display: grid; gap: 6px; margin-bottom: 10px; }
  .field label { color: $text-3; font-size: 12px; }
  .field input, .field textarea { width: 100%; background: #181320; border: 1px solid rgba(146,119,197,.45); color: variables.$ink; border-radius: 8px; padding: 10px 12px; outline: none; }
}

@media (max-width: 560px) {
  .flux-chat-page {
    .sugg-chip { width: 132px; height: 48px; font-size: 11px; padding: 0 8px; }
    .chip { width: 120px; height: 36px; font-size: 11px; }
  }
}

@media (max-width: 1100px) {
  .flux-chat-page .chat-grid { grid-template-columns: 1fr; height: calc(100svh - var(--navbar-h) - 80px); }
}